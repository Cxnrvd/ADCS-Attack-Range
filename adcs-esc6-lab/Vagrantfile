# -*- mode: ruby -*-
# vi: set ft=ruby :

# ==============================================================================
# ADCS ESC6 Lab - EDITF_ATTRIBUTESUBJECTALTNAME2
# ==============================================================================

# Lab Variables
DOMAIN_NAME    = "adcs.local"
DOMAIN_NETBIOS = "ADCS"
DC_IP          = "192.168.57.26"
CLIENT_IP      = "192.168.57.27"

Vagrant.configure("2") do |config|
  
  # Global: Disable box updates
  config.vm.box_check_update = false
  
  # Global: WinRM Configuration
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"
  config.winrm.transport = :plaintext
  config.winrm.basic_auth_only = true
  config.winrm.retry_limit = 80
  config.winrm.retry_delay = 30
  config.winrm.timeout = 1800
  
  # SSH fallback
  config.ssh.username = "vagrant"
  config.ssh.password = "vagrant"
  config.ssh.insert_key = false
  
  # Boot timeout
  config.vm.boot_timeout = 1200
  config.vm.graceful_halt_timeout = 120
  
  # ===========================================================================
  # DOMAIN CONTROLLER
  # ===========================================================================
  config.vm.define "dc", primary: true do |dc|
    dc.vm.box = "mayfly/windows_server2019"
    
    # NETWORK: Private Network Only
    dc.vm.network "private_network", ip: DC_IP
    
    dc.vm.provider "virtualbox" do |vb|
      vb.name = "ADCS-ESC6-DC"
      vb.memory = 8096
      vb.cpus = 2
      vb.gui = true 
    end

    # PROVISIONING SEQUENCE
    
    # 1. Set Hostname -> Reboot
    dc.vm.provision "shell", path: "scripts/set-hostname.ps1", reboot: true
    
    # 2. Install AD DS -> Reboot
    #    Passing variables so the script knows the domain name
    dc.vm.provision "shell", path: "scripts/dc-setup.ps1", reboot: true,
      env: {
        "DOMAIN_NAME" => DOMAIN_NAME,
        "DOMAIN_NETBIOS" => DOMAIN_NETBIOS
      }
    
    # 3. Add Users (Runs as Administrator)
    dc.vm.provision "shell", path: "scripts/add-users.ps1"
  end

  # ===========================================================================
  # CLIENT MACHINE
  # ===========================================================================
  config.vm.define "client", autostart: false do |client|
    client.vm.box = "mayfly/windows10"
    
    client.vm.network "private_network", ip: CLIENT_IP

    client.vm.provider "virtualbox" do |vb|
      vb.name = "ADCS-ESC6-CLIENT"
      vb.memory = 4096
      vb.cpus = 2
      vb.gui = false
    end

    # Provisioning - Reboot required for Domain Join
    client.vm.provision "shell", path: "scripts/client_provisioning.ps1", reboot: true,
      env: {
        "DC_IP" => DC_IP,
        "DOMAIN_NAME" => DOMAIN_NAME
      }
  end
end
