# -*- mode: ruby -*-
# vi: set ft=ruby :

# ==============================================================================
# ADCS ESC2 Lab - Vagrantfile
# ==============================================================================
# Replicated from successful ESC1 configuration
# ==============================================================================

# Lab paths
LAB_BASE_PATH = "E:\\ADCS\\adcs-esc2-lab"
PROVISION_PATH = File.join(LAB_BASE_PATH, "provision")

# Domain configuration
DOMAIN_NAME = "adcs.local"
DOMAIN_NETBIOS = "ADCS"

# Network configuration
DC_IP = "192.168.57.14"
CLIENT_IP = "192.168.57.17"
# Vagrant box names (EXACTLY AS ESC1)
DC_BOX = "mayfly/windows_server2019"
CLIENT_BOX = "mayfly/windows10"

# VM resources
DC_CPUS = 2
DC_MEMORY = 8096
CLIENT_CPUS = 2
CLIENT_MEMORY = 8096

# ==============================================================================
# VAGRANT CONFIGURATION
# ==============================================================================

Vagrant.configure("2") do |config|
  
  # Global Settings
  config.vm.box_check_update = false
  
  # Configure WinRM (Standard ESC1 config)
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"
  config.winrm.transport = :plaintext
  config.winrm.basic_auth_only = true
  config.winrm.retry_limit = 30
  config.winrm.retry_delay = 10
  config.winrm.timeout = 1800
  
  # SSH fallback
  config.ssh.username = "vagrant"
  config.ssh.password = "vagrant"
  config.ssh.insert_key = false
  
  # Boot timeout
  config.vm.boot_timeout = 1200
  config.vm.graceful_halt_timeout = 120
  
  # ===========================================================================
  # DC - Domain Controller
  # ===========================================================================
  
  config.vm.define "dc", primary: true do |dc|
    dc.vm.box = DC_BOX
    dc.vm.hostname = "ESC2-DC"
    
    # Network - static IP on host-only (Same as ESC1)
    dc.vm.network "private_network", 
                  ip: DC_IP,
                  netmask: "255.255.255.0",
                  auto_config: true
    
    # VirtualBox settings
    dc.vm.provider "virtualbox" do |vb|
      vb.name = "ADCS-ESC2-DC"  # Standard naming
      vb.gui = false             # Keep GUI for monitoring
      vb.cpus = DC_CPUS
      vb.memory = DC_MEMORY
      
      # Standard optimizations (NO VIRTIO)
      vb.customize ["modifyvm", :id, "--audio", "none"]
      vb.customize ["modifyvm", :id, "--usb", "off"]
      vb.customize ["modifyvm", :id, "--usbehci", "off"]
      vb.customize ["modifyvm", :id, "--accelerate3d", "off"]
      vb.customize ["modifyvm", :id, "--clipboard-mode", "bidirectional"]
      vb.customize ["modifyvm", :id, "--drag-and-drop", "bidirectional"]
      vb.customize ["modifyvm", :id, "--paravirtprovider", "minimal"]
      vb.customize ["modifyvm", :id, "--vram", "32"]
      vb.customize ["modifyvm", :id, "--ioapic", "on"]
    end
    
    # Provisioning
    dc.vm.provision "file", source: "#{PROVISION_PATH}/helpers.ps1", destination: "C:\\provision\\helpers.ps1"
    dc.vm.provision "shell", path: "#{PROVISION_PATH}/dc-provision.ps1",
                    env: {
                      "DC_IP" => DC_IP,
                      "DOMAIN_NAME" => DOMAIN_NAME,
                      "DOMAIN_NETBIOS" => DOMAIN_NETBIOS
                    }
  end
  
  # ===========================================================================
  # CLIENT01
  # ===========================================================================
  
  config.vm.define "client01", autostart: false do |client|
    client.vm.box = CLIENT_BOX
    client.vm.hostname = "ESC2-CLIENT01"
    
    client.vm.network "private_network",
                      ip: CLIENT_IP,
                      netmask: "255.255.255.0",
                      auto_config: true
    
    client.vm.provider "virtualbox" do |vb|
      vb.name = "ADCS-ESC2-CLIENT01"
      vb.gui = false
      vb.cpus = CLIENT_CPUS
      vb.memory = CLIENT_MEMORY
      
      vb.customize ["modifyvm", :id, "--audio", "none"]
      vb.customize ["modifyvm", :id, "--usb", "off"]
      vb.customize ["modifyvm", :id, "--usbehci", "off"]
      vb.customize ["modifyvm", :id, "--accelerate3d", "off"]
      vb.customize ["modifyvm", :id, "--clipboard-mode", "bidirectional"]
      vb.customize ["modifyvm", :id, "--drag-and-drop", "bidirectional"]
      vb.customize ["modifyvm", :id, "--paravirtprovider", "minimal"]
      vb.customize ["modifyvm", :id, "--vram", "32"]
      vb.customize ["modifyvm", :id, "--ioapic", "on"]
    end
    
    client.vm.provision "file", source: "#{PROVISION_PATH}/helpers.ps1", destination: "C:\\provision\\helpers.ps1"
    client.vm.provision "shell", path: "#{PROVISION_PATH}/client-provision.ps1",
                        env: {
                          "DC_IP" => DC_IP,
                          "CLIENT_IP" => CLIENT_IP,
                          "DOMAIN_NAME" => DOMAIN_NAME,
                          "DOMAIN_NETBIOS" => DOMAIN_NETBIOS
                        }
  end
end
